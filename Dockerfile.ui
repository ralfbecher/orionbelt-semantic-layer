# --- Build stage: install dependencies ---
FROM python:3.12-slim AS builder

ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Install dependencies first (cached layer â€” only reruns when pyproject.toml/uv.lock change)
COPY pyproject.toml uv.lock README.md ./
RUN uv sync --no-dev --extra ui --no-install-project --frozen

# Copy source and install the project itself
COPY src/ src/
COPY schema/ schema/
COPY examples/ examples/
COPY osi-obml/osi_obml_converter.py osi-obml/
COPY osi-obml/osi-schema.json osi-obml/
RUN uv sync --no-dev --extra ui --no-editable --frozen

# --- Runtime stage: minimal image ---
FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# Copy installed virtualenv from builder
COPY --from=builder /app/.venv /app/.venv
ENV PATH="/app/.venv/bin:$PATH"

# Copy examples (needed by Gradio UI for example model)
COPY --from=builder /app/examples examples/

# Copy schema (needed by OSI converter for OBML validation)
COPY --from=builder /app/schema schema/

# Copy OSI converter (needed by Gradio UI for OSI import/export)
COPY --from=builder /app/osi-obml osi-obml/

# Cloud Run injects PORT (default 7860 for Gradio)
# API_BASE_URL must point to the API service (e.g. https://orionbelt-api-xxxxx.run.app)
ENV PORT=7860 \
    API_BASE_URL="" \
    LOG_LEVEL=INFO

EXPOSE ${PORT}

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD python -c "import urllib.request; urllib.request.urlopen(f'http://localhost:{__import__(\"os\").environ[\"PORT\"]}/')"

CMD ["sh", "-c", "orionbelt-ui"]

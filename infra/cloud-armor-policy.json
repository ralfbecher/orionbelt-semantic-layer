{
  "name": "default-security-policy-for-backend-service-orionbelt-backend",
  "description": "Cloud Armor WAF policy for OrionBelt Semantic Layer API",
  "type": "CLOUD_ARMOR",
  "region": "europe-west1",
  "rules": [
    {
      "priority": 100,
      "action": "deny(403)",
      "description": "Block known vulnerability scanners",
      "match": {
        "expr": {
          "expression": "request.headers['user-agent'].lower().matches('.*libredtail.*|.*zgrab.*|.*masscan.*|.*nuclei.*|.*nikto.*|.*sqlmap.*|.*dirbuster.*|.*gobuster.*|.*nmap.*|.*python-requests.*|.*go-http-client.*|.*httpx.*')"
        }
      }
    },
    {
      "priority": 101,
      "action": "deny(404)",
      "description": "Block all PHP file probes",
      "match": {
        "expr": {
          "expression": "request.path.lower().matches(\".*[.]php.*\")"
        }
      }
    },
    {
      "priority": 102,
      "action": "deny(404)",
      "description": "Block common exploit paths",
      "match": {
        "expr": {
          "expression": "request.path.lower().matches(\".*containers/json.*|.*/vendor/.*|.*wp-admin.*|.*wp-login.*|.*wp-content.*|.*cgi-bin.*|.*[.]env.*|.*[.]git.*\")"
        }
      }
    },
    {
      "priority": 103,
      "action": "deny(413)",
      "description": "Block model/validate bodies > 5 MB",
      "match": {
        "expr": {
          "expression": "has(request.headers[\"content-length\"]) && int(request.headers[\"content-length\"]) > 5242880 && request.path.matches(\".*/models$|.*/validate$\")"
        }
      }
    },
    {
      "priority": 104,
      "action": "deny(403)",
      "description": "Block PUT/PATCH/TRACE/CONNECT methods",
      "match": {
        "expr": {
          "expression": "request.method.matches(\"PUT|PATCH|TRACE|CONNECT\")"
        }
      }
    },
    {
      "priority": 106,
      "action": "deny(413)",
      "description": "Block request bodies > 1 MB (non-model endpoints)",
      "match": {
        "expr": {
          "expression": "has(request.headers[\"content-length\"]) && int(request.headers[\"content-length\"]) > 1048576 && !request.path.matches(\".*/models$|.*/validate$\")"
        }
      }
    },
    {
      "priority": 200,
      "action": "deny(403)",
      "description": "OWASP scanner detection (sensitivity 1)",
      "match": {
        "expr": {
          "expression": "evaluatePreconfiguredExpr('scannerdetection-v33-stable', ['owasp-crs-v030301-id913101-scannerdetection', 'owasp-crs-v030301-id913102-scannerdetection'])"
        }
      }
    },
    {
      "priority": 202,
      "action": "deny(403)",
      "description": "OWASP RCE protection (sensitivity 1)",
      "match": {
        "expr": {
          "expression": "evaluatePreconfiguredExpr('rce-v33-stable', ['owasp-crs-v030301-id932200-rce', 'owasp-crs-v030301-id932106-rce', 'owasp-crs-v030301-id932190-rce'])"
        }
      }
    },
    {
      "priority": 203,
      "action": "deny(403)",
      "description": "OWASP RFI protection (sensitivity 1)",
      "match": {
        "expr": {
          "expression": "evaluatePreconfiguredExpr('rfi-v33-stable', ['owasp-crs-v030301-id931130-rfi'])"
        }
      }
    },
    {
      "priority": 204,
      "action": "deny(403)",
      "description": "OWASP protocol attack protection (sensitivity 1)",
      "match": {
        "expr": {
          "expression": "evaluatePreconfiguredExpr('protocolattack-v33-stable', ['owasp-crs-v030301-id921151-protocolattack', 'owasp-crs-v030301-id921170-protocolattack'])"
        }
      }
    },
    {
      "priority": 205,
      "action": "deny(403)",
      "description": "Known CVE exploits (Log4Shell etc.)",
      "match": {
        "expr": {
          "expression": "evaluatePreconfiguredExpr('cve-canary')"
        }
      }
    },
    {
      "priority": 1000,
      "action": "allow",
      "description": "Allow Gradio UI paths without rate limiting",
      "match": {
        "expr": {
          "expression": "request.path.startsWith('/ui')"
        }
      }
    },
    {
      "priority": 2147483646,
      "action": "throttle",
      "description": "Rate limiting: 1000 req/min per IP",
      "match": {
        "versionedExpr": "SRC_IPS_V1",
        "config": {
          "srcIpRanges": ["*"]
        }
      },
      "rateLimitOptions": {
        "conformAction": "allow",
        "enforceOnKey": "IP",
        "exceedAction": "deny(403)",
        "rateLimitThreshold": {
          "count": 1000,
          "intervalSec": 60
        }
      }
    },
    {
      "priority": 2147483647,
      "action": "allow",
      "description": "Default allow all",
      "match": {
        "versionedExpr": "SRC_IPS_V1",
        "config": {
          "srcIpRanges": ["*"]
        }
      }
    }
  ]
}
